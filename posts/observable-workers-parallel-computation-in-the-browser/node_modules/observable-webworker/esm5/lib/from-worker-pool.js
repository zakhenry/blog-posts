/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Observable, of, Subject, zip } from 'rxjs';
import { finalize, map, mergeAll, tap } from 'rxjs/operators';
import { fromWorker } from './from-worker';
/**
 * @record
 */
function LazyWorker() { }
if (false) {
    /** @type {?} */
    LazyWorker.prototype.factory;
    /** @type {?} */
    LazyWorker.prototype.terminate;
    /** @type {?} */
    LazyWorker.prototype.processing;
    /** @type {?} */
    LazyWorker.prototype.started;
    /** @type {?} */
    LazyWorker.prototype.index;
}
/**
 * @record
 * @template I, O
 */
export function WorkerPoolOptions() { }
if (false) {
    /** @type {?|undefined} */
    WorkerPoolOptions.prototype.workerCount;
    /** @type {?|undefined} */
    WorkerPoolOptions.prototype.flattenOperator;
    /** @type {?|undefined} */
    WorkerPoolOptions.prototype.selectTransferables;
}
/**
 * @template I, O
 * @param {?} workerConstructor
 * @param {?} workUnitIterator
 * @param {?=} options
 * @return {?}
 */
export function fromWorkerPool(workerConstructor, workUnitIterator, options) {
    var _a = options || {}, 
    // tslint:disable-next-line:no-unnecessary-initializer
    _b = _a.selectTransferables, 
    // tslint:disable-next-line:no-unnecessary-initializer
    selectTransferables = _b === void 0 ? undefined : _b, _c = _a.workerCount, workerCount = _c === void 0 ? navigator.hardwareConcurrency - 1 : _c, _d = _a.flattenOperator, flattenOperator = _d === void 0 ? mergeAll() : _d;
    return new Observable((/**
     * @param {?} resultObserver
     * @return {?}
     */
    function (resultObserver) {
        /** @type {?} */
        var idleWorker$$ = new Subject();
        /** @type {?} */
        var completed = 0;
        /** @type {?} */
        var sent = 0;
        /** @type {?} */
        var finished = false;
        /** @type {?} */
        var lazyWorkers = Array.from({ length: workerCount }).map((/**
         * @param {?} _
         * @param {?} index
         * @return {?}
         */
        function (_, index) {
            return {
                _cachedWorker: null,
                factory: /**
                 * @return {?}
                 */
                function () {
                    if (!this._cachedWorker) {
                        this._cachedWorker = workerConstructor(index);
                        this.started = true;
                    }
                    return this._cachedWorker;
                },
                terminate: /**
                 * @return {?}
                 */
                function () {
                    if (this.started && !this.processing) {
                        this._cachedWorker.terminate();
                    }
                },
                processing: false,
                started: false,
                index: index,
            };
        }));
        /** @type {?} */
        var processor$ = zip(idleWorker$$, workUnitIterator).pipe(tap((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = tslib_1.__read(_a, 1), worker = _b[0];
            sent++;
            worker.processing = true;
        })), finalize((/**
         * @return {?}
         */
        function () {
            idleWorker$$.complete();
            finished = true;
            lazyWorkers.forEach((/**
             * @param {?} worker
             * @return {?}
             */
            function (worker) { return worker.terminate(); }));
        })), map((/**
         * @param {?} __0
         * @return {?}
         */
        function (_a) {
            var _b = tslib_1.__read(_a, 2), worker = _b[0], unitWork = _b[1];
            return fromWorker((/**
             * @return {?}
             */
            function () { return worker.factory(); }), of(unitWork), selectTransferables, {
                terminateOnComplete: false,
            }).pipe(finalize((/**
             * @return {?}
             */
            function () {
                completed++;
                worker.processing = false;
                if (!finished) {
                    idleWorker$$.next(worker);
                }
                else {
                    worker.terminate();
                }
                if (finished && completed === sent) {
                    resultObserver.complete();
                }
            })));
        })), flattenOperator);
        /** @type {?} */
        var sub = processor$.subscribe(resultObserver);
        lazyWorkers.forEach((/**
         * @param {?} w
         * @return {?}
         */
        function (w) { return idleWorker$$.next(w); }));
        return (/**
         * @return {?}
         */
        function () { return sub.unsubscribe(); });
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJvbS13b3JrZXItcG9vbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL29ic2VydmFibGUtd2Vid29ya2VyLyIsInNvdXJjZXMiOlsibGliL2Zyb20td29ya2VyLXBvb2wudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFtQixFQUFFLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyRSxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7OztBQUUzQyx5QkFNQzs7O0lBTEMsNkJBQXNCOztJQUN0QiwrQkFBc0I7O0lBQ3RCLGdDQUFvQjs7SUFDcEIsNkJBQWlCOztJQUNqQiwyQkFBYzs7Ozs7O0FBR2hCLHVDQUlDOzs7SUFIQyx3Q0FBcUI7O0lBQ3JCLDRDQUF1RTs7SUFDdkUsZ0RBQW1EOzs7Ozs7Ozs7QUFHckQsTUFBTSxVQUFVLGNBQWMsQ0FDNUIsaUJBQTRDLEVBQzVDLGdCQUFvQyxFQUNwQyxPQUFpQztJQUUzQixJQUFBLGtCQUtXO0lBSmYsc0RBQXNEO0lBQ3RELDJCQUErQjtJQUQvQixzREFBc0Q7SUFDdEQsb0RBQStCLEVBQy9CLG1CQUErQyxFQUEvQyxvRUFBK0MsRUFDL0MsdUJBQStCLEVBQS9CLGlEQUNlO0lBRWpCLE9BQU8sSUFBSSxVQUFVOzs7O0lBQUksVUFBQSxjQUFjOztZQUMvQixZQUFZLEdBQXdCLElBQUksT0FBTyxFQUFFOztZQUVuRCxTQUFTLEdBQUcsQ0FBQzs7WUFDYixJQUFJLEdBQUcsQ0FBQzs7WUFDUixRQUFRLEdBQUcsS0FBSzs7WUFFZCxXQUFXLEdBQWlCLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxHQUFHOzs7OztRQUFDLFVBQUMsQ0FBQyxFQUFFLEtBQUs7WUFDakYsT0FBTztnQkFDTCxhQUFhLEVBQUUsSUFBSTtnQkFDbkIsT0FBTzs7OztvQkFDTCxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRTt3QkFDdkIsSUFBSSxDQUFDLGFBQWEsR0FBRyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQzt3QkFDOUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7cUJBQ3JCO29CQUNELE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztnQkFDNUIsQ0FBQztnQkFDRCxTQUFTOzs7O29CQUNQLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7d0JBQ3BDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFLENBQUM7cUJBQ2hDO2dCQUNILENBQUM7Z0JBQ0QsVUFBVSxFQUFFLEtBQUs7Z0JBQ2pCLE9BQU8sRUFBRSxLQUFLO2dCQUNkLEtBQUssT0FBQTthQUNOLENBQUM7UUFDSixDQUFDLEVBQUM7O1lBRUksVUFBVSxHQUFHLEdBQUcsQ0FBQyxZQUFZLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQyxJQUFJLENBQ3pELEdBQUc7Ozs7UUFBQyxVQUFDLEVBQVE7Z0JBQVIsMEJBQVEsRUFBUCxjQUFNO1lBQ1YsSUFBSSxFQUFFLENBQUM7WUFDUCxNQUFNLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUMzQixDQUFDLEVBQUMsRUFDRixRQUFROzs7UUFBQztZQUNQLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUN4QixRQUFRLEdBQUcsSUFBSSxDQUFDO1lBQ2hCLFdBQVcsQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQSxNQUFNLElBQUksT0FBQSxNQUFNLENBQUMsU0FBUyxFQUFFLEVBQWxCLENBQWtCLEVBQUMsQ0FBQztRQUNwRCxDQUFDLEVBQUMsRUFDRixHQUFHOzs7O1FBQ0QsVUFBQyxFQUFrQjtnQkFBbEIsMEJBQWtCLEVBQWpCLGNBQU0sRUFBRSxnQkFBUTtZQUNoQixPQUFPLFVBQVU7OztZQUFPLGNBQU0sT0FBQSxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQWhCLENBQWdCLEdBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLG1CQUFtQixFQUFFO2dCQUNqRixtQkFBbUIsRUFBRSxLQUFLO2FBQzNCLENBQUMsQ0FBQyxJQUFJLENBQ0wsUUFBUTs7O1lBQUM7Z0JBQ1AsU0FBUyxFQUFFLENBQUM7Z0JBRVosTUFBTSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7Z0JBRTFCLElBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQ2IsWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDM0I7cUJBQU07b0JBQ0wsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO2lCQUNwQjtnQkFFRCxJQUFJLFFBQVEsSUFBSSxTQUFTLEtBQUssSUFBSSxFQUFFO29CQUNsQyxjQUFjLENBQUMsUUFBUSxFQUFFLENBQUM7aUJBQzNCO1lBQ0gsQ0FBQyxFQUFDLENBQ0gsQ0FBQztRQUNKLENBQUMsRUFDRixFQUNELGVBQWUsQ0FDaEI7O1lBRUssR0FBRyxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDO1FBRWhELFdBQVcsQ0FBQyxPQUFPOzs7O1FBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFwQixDQUFvQixFQUFDLENBQUM7UUFFL0M7OztRQUFPLGNBQU0sT0FBQSxHQUFHLENBQUMsV0FBVyxFQUFFLEVBQWpCLENBQWlCLEVBQUM7SUFDakMsQ0FBQyxFQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgT2JzZXJ2YWJsZUlucHV0LCBvZiwgU3ViamVjdCwgemlwIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaW5hbGl6ZSwgbWFwLCBtZXJnZUFsbCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgZnJvbVdvcmtlciB9IGZyb20gJy4vZnJvbS13b3JrZXInO1xuXG5pbnRlcmZhY2UgTGF6eVdvcmtlciB7XG4gIGZhY3Rvcnk6ICgpID0+IFdvcmtlcjtcbiAgdGVybWluYXRlOiAoKSA9PiB2b2lkO1xuICBwcm9jZXNzaW5nOiBib29sZWFuO1xuICBzdGFydGVkOiBib29sZWFuO1xuICBpbmRleDogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFdvcmtlclBvb2xPcHRpb25zPEksIE8+IHtcbiAgd29ya2VyQ291bnQ/OiBudW1iZXI7XG4gIGZsYXR0ZW5PcGVyYXRvcj86IChpbnB1dCQ6IE9ic2VydmFibGU8T2JzZXJ2YWJsZTxPPj4pID0+IE9ic2VydmFibGU8Tz47XG4gIHNlbGVjdFRyYW5zZmVyYWJsZXM/OiAoaW5wdXQ6IEkpID0+IFRyYW5zZmVyYWJsZVtdO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZnJvbVdvcmtlclBvb2w8SSwgTz4oXG4gIHdvcmtlckNvbnN0cnVjdG9yOiAoaW5kZXg6IG51bWJlcikgPT4gV29ya2VyLFxuICB3b3JrVW5pdEl0ZXJhdG9yOiBPYnNlcnZhYmxlSW5wdXQ8ST4sXG4gIG9wdGlvbnM/OiBXb3JrZXJQb29sT3B0aW9uczxJLCBPPixcbik6IE9ic2VydmFibGU8Tz4ge1xuICBjb25zdCB7XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVubmVjZXNzYXJ5LWluaXRpYWxpemVyXG4gICAgc2VsZWN0VHJhbnNmZXJhYmxlcyA9IHVuZGVmaW5lZCxcbiAgICB3b3JrZXJDb3VudCA9IG5hdmlnYXRvci5oYXJkd2FyZUNvbmN1cnJlbmN5IC0gMSxcbiAgICBmbGF0dGVuT3BlcmF0b3IgPSBtZXJnZUFsbDxPPigpLFxuICB9ID0gb3B0aW9ucyB8fCB7fTtcblxuICByZXR1cm4gbmV3IE9ic2VydmFibGU8Tz4ocmVzdWx0T2JzZXJ2ZXIgPT4ge1xuICAgIGNvbnN0IGlkbGVXb3JrZXIkJDogU3ViamVjdDxMYXp5V29ya2VyPiA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgICBsZXQgY29tcGxldGVkID0gMDtcbiAgICBsZXQgc2VudCA9IDA7XG4gICAgbGV0IGZpbmlzaGVkID0gZmFsc2U7XG5cbiAgICBjb25zdCBsYXp5V29ya2VyczogTGF6eVdvcmtlcltdID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogd29ya2VyQ291bnQgfSkubWFwKChfLCBpbmRleCkgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgX2NhY2hlZFdvcmtlcjogbnVsbCxcbiAgICAgICAgZmFjdG9yeSgpIHtcbiAgICAgICAgICBpZiAoIXRoaXMuX2NhY2hlZFdvcmtlcikge1xuICAgICAgICAgICAgdGhpcy5fY2FjaGVkV29ya2VyID0gd29ya2VyQ29uc3RydWN0b3IoaW5kZXgpO1xuICAgICAgICAgICAgdGhpcy5zdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2NhY2hlZFdvcmtlcjtcbiAgICAgICAgfSxcbiAgICAgICAgdGVybWluYXRlKCkge1xuICAgICAgICAgIGlmICh0aGlzLnN0YXJ0ZWQgJiYgIXRoaXMucHJvY2Vzc2luZykge1xuICAgICAgICAgICAgdGhpcy5fY2FjaGVkV29ya2VyLnRlcm1pbmF0ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgcHJvY2Vzc2luZzogZmFsc2UsXG4gICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLFxuICAgICAgICBpbmRleCxcbiAgICAgIH07XG4gICAgfSk7XG5cbiAgICBjb25zdCBwcm9jZXNzb3IkID0gemlwKGlkbGVXb3JrZXIkJCwgd29ya1VuaXRJdGVyYXRvcikucGlwZShcbiAgICAgIHRhcCgoW3dvcmtlcl0pID0+IHtcbiAgICAgICAgc2VudCsrO1xuICAgICAgICB3b3JrZXIucHJvY2Vzc2luZyA9IHRydWU7XG4gICAgICB9KSxcbiAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgaWRsZVdvcmtlciQkLmNvbXBsZXRlKCk7XG4gICAgICAgIGZpbmlzaGVkID0gdHJ1ZTtcbiAgICAgICAgbGF6eVdvcmtlcnMuZm9yRWFjaCh3b3JrZXIgPT4gd29ya2VyLnRlcm1pbmF0ZSgpKTtcbiAgICAgIH0pLFxuICAgICAgbWFwKFxuICAgICAgICAoW3dvcmtlciwgdW5pdFdvcmtdKTogT2JzZXJ2YWJsZTxPPiA9PiB7XG4gICAgICAgICAgcmV0dXJuIGZyb21Xb3JrZXI8SSwgTz4oKCkgPT4gd29ya2VyLmZhY3RvcnkoKSwgb2YodW5pdFdvcmspLCBzZWxlY3RUcmFuc2ZlcmFibGVzLCB7XG4gICAgICAgICAgICB0ZXJtaW5hdGVPbkNvbXBsZXRlOiBmYWxzZSxcbiAgICAgICAgICB9KS5waXBlKFxuICAgICAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgICAgICBjb21wbGV0ZWQrKztcblxuICAgICAgICAgICAgICB3b3JrZXIucHJvY2Vzc2luZyA9IGZhbHNlO1xuXG4gICAgICAgICAgICAgIGlmICghZmluaXNoZWQpIHtcbiAgICAgICAgICAgICAgICBpZGxlV29ya2VyJCQubmV4dCh3b3JrZXIpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHdvcmtlci50ZXJtaW5hdGUoKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIGlmIChmaW5pc2hlZCAmJiBjb21wbGV0ZWQgPT09IHNlbnQpIHtcbiAgICAgICAgICAgICAgICByZXN1bHRPYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICApO1xuICAgICAgICB9LFxuICAgICAgKSxcbiAgICAgIGZsYXR0ZW5PcGVyYXRvcixcbiAgICApO1xuXG4gICAgY29uc3Qgc3ViID0gcHJvY2Vzc29yJC5zdWJzY3JpYmUocmVzdWx0T2JzZXJ2ZXIpO1xuXG4gICAgbGF6eVdvcmtlcnMuZm9yRWFjaCh3ID0+IGlkbGVXb3JrZXIkJC5uZXh0KHcpKTtcblxuICAgIHJldHVybiAoKSA9PiBzdWIudW5zdWJzY3JpYmUoKTtcbiAgfSk7XG59XG4iXX0=